CREATE OR REPLACE TABLE "MARKETING_SANDBOX"."TABLEAU_REPORTING".WEBSITE_REPORTING_OVERHAUL AS(
WITH cte_pageview AS(
    SELECT pv.SESSIONKEY
        , MAX(pv.PAGEVIEWORDERINSESSION) AS PageViews
        , MAX(CASE WHEN dwp.Category = 'GA1' THEN 1 ELSE 0 END) AS HadGA1View
        , SUM(CASE WHEN dwp.CATEGORY = 'VDP' THEN 1 ELSE 0 END) AS VDPViews
    FROM MARKETING.WEBSITE.PAGEVIEW pv
    LEFT JOIN MARKETING.WEBSITE.DIMWEBPAGE dwp ON pv.WEBPAGEKEY = dwp.WEBPAGEKEY 
    LEFT JOIN MARKETING.WEBSITE.PAGEVIEW pv2 ON pv.SESSIONKEY = pv2.SESSIONKEY AND pv.PAGEVIEWORDERINSESSION = (pv2.PAGEVIEWORDERINSESSION - 1)
    LEFT JOIN SHARED.DIMENSION.DATE d on pv.PAGEVIEWSTARTDATEKEY = d.DATE_KEY 
    WHERE CALENDAR_DATE > dateadd('month', -1 , current_date())
    GROUP BY pv.SESSIONKEY
)
    
SELECT USERKEY
    , (CASE WHEN USERSESSIONORDER < 2 THEN 'New User'
            WHEN UserSessionOrder > 1 THEN 'Returning User' END) AS UserType 
    , CASE WHEN SHOPPERTYPE = 'Finance' THEN 1 ELSE 0 END AS IsFinanceShopper
    , CASE WHEN SHOPPERTYPE = 'Vehicle' THEN 1 ELSE 0 END AS IsVehicleShopper
    , CASE WHEN ShopperType = 'Unspecified' THEN 1 ELSE 0 END AS IsUnspecfiedShopper
    , USERSESSIONORDER
    , BROWSERNAME
    , PLATFORM
    , HOUR
    , dwp.CATEGORY
    , SHOPPERTYPE
    , CALENDAR_DATE
    , s.SESSIONKEY
    , ISLIFECYCLEGENERATINGSESSION
    , HASINSTOREAPP
    , HASGA1
    , HASGA2
    , HASSALE
    , HASSAV
    , CREDITGRADE
    , SPLITCREDITGRADE
    , FICO
    , INCOME
    , SESSIONDURATIONINSECONDS
    , DOWNPAYMENTBUCKET
    , INCOMEBUCKET
    , MEP
    , DEALSCORETIER
    , PageViews
    , HadGA1View 
    , VDPViews 
    , ISBOUNCEDSESSION
    , INCREMENTALNPV
FROM MARKETING.WEBSITE.SESSION s 
    LEFT JOIN SHARED.DIMENSION.DATE d ON s.SESSIONSTARTDATEKEY = d.DATE_KEY 
    LEFT JOIN MARKETING.WEBSITE.DIMINTERNETDEVICE did ON s.INTERNETDEVICEKEY = did.INTERNETDEVICEKEY 
    LEFT JOIN MARKETING.WEBSITE.DIMDEVICEVIEW ddv ON s.DEVICEVIEWKEY = ddv.DEVICEVIEWKEY
    LEFT JOIN MARKETING.LEAD.CENTRALIZEDLEADSOURCE cls ON s.SESSIONID = cls.SESSIONID
    LEFT JOIN MARKETING.WEBSITE.DIMWEBPAGE dwp ON s.LANDINGPAGEKEY = dwp.webpagekey
    LEFT JOIN cte_pageview pv ON s.SESSIONKEY = pv.SESSIONKEY
    LEFT JOIN MARKETING.WEBSITE.DIMIPADDRESS dip ON s.IPADDRESSKEY = dip.IPADDRESSKEY
    LEFT JOIN "RISK"."LOANVAL2"."NPVSCENARIOS" npv ON cls.AccountNumber = npv.AccountNumber AND npv.CostOfDebt = 0.055 AND npv.CostOfEquity = 0.2
    LEFT JOIN SHARED.DIMENSION.TIME t on s.SESSIONSTARTTIMEKEY = t.timekey
WHERE CALENDAR_DATE > dateadd('month', -1 , current_date())
AND IsBot = 0
AND (InternalIP = 0 OR InternalIP IS NULL)
AND (BROWSERNAME != 'Firefox' AND SCREENWIDTH != 800)
AND (BROWSERNAME != 'Chrome' and SCREENWIDTH != 800)
AND DEVICENAME != 'Samsung SM-G930V'
AND ISBOT = 0);

